---
published: false
---
最近重读的 Stevens 老先生的TCP/IP详解，梳理了一下，打算把自己理解的写出来。  
TCP/IP是一种面向连接的、可靠的、基于字节流的传输层通信协议，它会保证数据不丢包、不乱序。TCP全名是Transmission Control Protocol，它是位于网络OSI模型中的第四层(Transport layer)。
### TCP 首部

![TCP首部]({{site.baseurl}}/_posts/tcp%20header.jpg)![tcp header.jpg]({{site.baseurl}}/_posts/tcp header.jpg)
- Port  
每个TCP数据段都包含源端口和目的端口号，用于寻找发送端和接收端的应用进程。这两个值加上IP首部中的源端IP和目的端IP地址唯有时候我们也会把它称为socket四元组（源IP地址、目的IP地址、源端口、目的端口）
- Sequence number  
序列号用来标识从TCP发送端向TCO接收端发送的数据字节流，它标识在这个报文段中的第一个数据字节。序号是32 bit的无符号数，序号到达232－1后又从0开始。TCP为应用层提供全双工服务。这意味数据能在两个方向上独立地进行传输。因此，连接的每一端必须保持每个方向上的传输数据序号。
- Acknowledgment number  
确认号，和序列号类似，**不过它是用来确认已经收到的序号并下次想收到的序号**。这两个序号保证了TCP传输过程中不乱序、不丢包的问题。
- TCP Flag  
NS：隐藏保护。  
CWR：发送主机设置拥塞窗口减少（CWR）标志，以指示它收到了一个设置了ECE标志的TCP段，并在拥塞控制机制中作出响应。  
ECE：ECN-Echo具有双重角色，具体取决于SYN标志的值。它表明：  
如果SYN标志设置为（1），则TCP对等体具有ECN能力。  
如果SYN标志为清除（0），则在正常传输期间接收到IP报头中具有拥塞经历标志设置（ECN = 11）的分组。这用作TCP发送方的网络拥塞（或即将发生的拥塞）的指示。  
URG：表示紧急指针字段是重要的  
ACK：表示确认字段是重要的。客户端发送的初始SYN数据包之后的所有数据包都应设置此标志。  
PSH：推送功能。要求将缓冲的数据推送到接收应用程序。  
RST：重置连接  
SYN：同步序列号。只有从每一端发送的第一个数据包应该设置此标志。其他一些标志和字段会根据此标志更改含义，有些仅在设置时有效，有些仅在明确时有效。  
FIN：来自发送方的最后一个数据包。  
关于SYN和FIN可以参考我这篇文章[TCP三次握手和四次挥手](https://zhaodezhen.github.io/dezhen.github.io/2019/03/15/TCP-3-way-and-4-way-handshake.html)
- Window size   
TCP的流量控制是由连接的每一端通过声明窗口大小来提供。Window size 是一个16bit的字段，所以窗口最大为65535。
- Checksum
它是有发送端计算，然后接收端进行验证。其目的是为了保证在传输过程中出现什么差错，如果校验和验证失败，TCP直接丢弃这个数据段（校验过程中会涉及到一个伪首部，伪首部的数据都是从IP数据报头获取的，其目的就是为了检测TCP数据段是否已经正确到达，只是单纯用来做校验的）。 
- Urgent pointer 
紧急指针，它只在URG标志设置为1的时候生效。  

### TCP 数据传输
TCP的建立连接之前写过一篇文章，所以就不在这里细赘了，我们直接聊TCP数据传输中如何保证数据的传输顺序和丢包问题的，以及怎么提高TCP传输的吞吐量。  
- Acknowledgement of delay  
通常TCP在收到数据的时候不会立刻发送一个ACK确认，它会延迟发送，可以和对方需要的数据一起发送（数据捎带ACK）或者是等待第二个数据来了直接回复第二个ACK，通常的实现采用的延迟是200ms(就是说它会等待200ms有没有数据一起发送)  
- Nagle   
在数据传输过程中，通常会遇到一些小分组的传输（比如 41 bit的数据分组，除去TCP首部和IP首部真正传输的数据只有1 bit），像这种小分组多的话，在网络上传输就加大了造成网络拥塞的可能。为了提传输效率，所以提出了Nagle算法。  
这个算法要求一个TCP连接最多只能有一个未被确认的未完成的小分组，在该分组到达之前不能发送其他的小分组。然后，TCP会收集这些小分组，并在确认到来时以一个分组的方式发送出去，这样就可以有效的减少了小分组。
在一些实时性要求比较高的场景下，采用了Nagle算法会让用户感觉到时延，所以我们可以选择关闭Nagle算法，Socket API 可以用 TCP_NODELAY 选项来关闭，nginx上的 tcp_nodely也是采用的这个系统调用。 
- Retransmission  
TCP为了保证数据不丢失所采用的重传策略。 TCP超时重传比较严重，它表示已经超时了还没有收到数据确认的回复，所以他会进入到慢启动，而快速重传则不用。  
TCP超时重传：TCP发送方首先会维护一个TCP的重传定时器(有的也叫超时时间RTO)，这个定时器是根据往返时间（RTT）进行计算，具体算法的实现可以参考 [RFC 6298](https://tools.ietf.org/html/rfc6298)，当ROT到了还没有收到数据的确认，那么TCP就认为数据已经丢失了。TCP会重传数据，接着进入到拥塞控制里的慢启动（关于拥塞控制会在后面讲）。   
TCP快速重传：**它主要是收到了三个重复的ACK后**（接受方如果收到的数据是乱序的。它会重发自己最近接收到的正确顺序的ACK）进行重传，因为收到重复的ACK代表数据已经发送过去了，其中的一个数据可能因为其他原因（如数据传输中换了比较远的路由，或者是数据干脆直接丢了）造成数据没有收到。所以这个情况不算太严重，它不会进入到慢启动，它会进入到快速恢复。

### TCP 拥塞控制  
未完待续。。。

